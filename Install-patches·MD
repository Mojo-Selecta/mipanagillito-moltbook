# ğŸ›¡ï¸ GILLITO v6.1 â€” Security Patches Install Guide

## QuÃ© se parchÃ³ (basado en TU cÃ³digo exacto)

---

## ğŸ“ Archivos a REEMPLAZAR

### Scripts â†’ `scripts/`

| Archivo | Cambios |
|---------|---------|
| `post-to-x.js` | ğŸ”§ 3 syntax fixes + ğŸ›¡ï¸ `sec.processOutput()` antes de `C.xPost()` |
| `post-to-moltbook.js` | ğŸ”§ 3 syntax fixes + ğŸ›¡ï¸ `sec.processOutput()` antes de `C.moltPostWithFallback()` |
| `gillito-god-mode.js` | ğŸ›¡ï¸ `secureOutput()` wrapper + `processExternalContent()` en searchAndComment |

### Workflows â†’ `.github/workflows/`

| Archivo | Cambio |
|---------|--------|
| `x-reply.yml` | +1 cache step: `.gillito-mention-budget.json` (anti-spam) |
| `interact.yml` | +1 cache step: `.gillito-mention-budget.json` (anti-spam) |

---

## ğŸ”§ Bugs de sintaxis arreglados

Estos bugs estaban en tu cÃ³digo v6.0 y crasheaban los scripts:

### 1. Bracket faltante en `post-to-x.js` y `post-to-moltbook.js`

```javascript
// âŒ ANTES (SyntaxError):
P`temas_${modo.modo}`] || [modo.tema],

// âœ… DESPUÃ‰S:
P[`temas_${modo.modo}`] || [modo.tema],
```

### 2. Tagged template literals rotos en ambos scripts

```javascript
// âŒ ANTES (TypeError â€” log recibe un TemplateStringsArray):
C.log.info`ğŸ“ Tweet (${tweet.length} chars): ${tweet}`);
C.log.ok`Posteado: https://twitter.com/i/status/${result.id}`);
C.log.error`FallÃ³: ${result.error}`);

// âœ… DESPUÃ‰S (llamada normal con parÃ©ntesis):
C.log.info(`ğŸ“ Tweet (${tweet.length} chars): ${tweet}`);
C.log.ok(`Posteado: https://twitter.com/i/status/${result.id}`);
C.log.error(`FallÃ³: ${result.error}`);
```

---

## ğŸ›¡ï¸ Security additions (detalle)

### post-to-x.js â€” 6 lÃ­neas nuevas
```javascript
const sec = C.sec || require('./lib/security');  // lÃ­nea 14

// Antes de C.xPost():
const check = sec.processOutput(tweet);
if (!check.safe) {
  C.log.warn(`ğŸ›¡ï¸ Tweet BLOQUEADO: ${check.blocked.join(', ')}`);
  C.log.session();
  return;
}
// Luego usa check.text en vez de tweet
```

### post-to-moltbook.js â€” 7 lÃ­neas nuevas
```javascript
const sec = C.sec || require('./lib/security');  // lÃ­nea 14

// Antes de C.moltPostWithFallback():
const check = sec.processOutput(content);
if (!check.safe) {
  C.log.warn(`ğŸ›¡ï¸ Post BLOQUEADO: ${check.blocked.join(', ')}`);
  C.log.session();
  return;
}
// Luego usa check.text en vez de content
```

### gillito-god-mode.js â€” ~20 lÃ­neas nuevas
```javascript
const sec = C.sec || require('./lib/security');  // lÃ­nea 14

// Wrapper reutilizable:
function secureOutput(text, label) {
  const check = sec.processOutput(text);
  if (!check.safe) {
    C.log.warn(`ğŸ›¡ï¸ ${label} BLOQUEADO: ${check.blocked.join(', ')}`);
    return null;
  }
  return check.text;
}

// En searchAndComment() â€” sanitiza input externo:
const extCheck = sec.processExternalContent(postContent, authorId, author, 'moltbook-search');
if (!extCheck.proceed) continue;
// Usa extCheck.sanitized en vez del texto raw

// Valida output antes de publicar:
const safe = secureOutput(comment, `Comment a @${author}`);
if (!safe) continue;
```

### Workflows â€” 1 cache step nuevo en cada uno
```yaml
# Nuevo step en x-reply.yml e interact.yml:
- name: ğŸ›¡ï¸ Restore mention budget
  uses: actions/cache@v4
  with:
    path: .gillito-mention-budget.json
    key: x-mention-budget-${{ github.run_id }}
    restore-keys: x-mention-budget-
```

---

## ğŸ”§ InstalaciÃ³n

```bash
# Reemplazar scripts
cp post-to-x.js          REPO/scripts/post-to-x.js
cp post-to-moltbook.js   REPO/scripts/post-to-moltbook.js
cp gillito-god-mode.js   REPO/scripts/gillito-god-mode.js

# Reemplazar workflows
cp x-reply.yml            REPO/.github/workflows/x-reply.yml
cp interact.yml           REPO/.github/workflows/interact.yml

# Push
git add .
git commit -m "ğŸ›¡ï¸ v6.1 â€” security hardening + syntax fixes"
git push
```

---

## âœ… Estado Final

| Vector | ProtecciÃ³n | Estado |
|--------|-----------|--------|
| Prompt injection | `detectInjection()` | âœ… |
| Contenido malicioso | `sanitizeInput()` | âœ… |
| Spam de menciones | `checkMentionBudget()` | âœ… |
| Budget persistence | `actions/cache` | âœ… |
| Output leak (replies X) | `processOutput()` | âœ… |
| Output leak (replies Molt) | `processOutput()` | âœ… |
| Output leak (posts X) | `processOutput()` | âœ… |
| Output leak (posts Molt) | `processOutput()` | âœ… |
| Output leak (god-mode) | `secureOutput()` | âœ… |
| External input (god-mode) | `processExternalContent()` | âœ… |
| Secret en logs | `redactSecrets()` | âœ… |
| Defensive prompt | `DEFENSIVE_PROMPT` | âœ… |
| .gitignore | `.gillito-*.json` | âœ… |

### Pendiente manual (GitHub Settings):
- â¬œ Dependabot alerts â†’ ACTIVAR
- â¬œ Code scanning â†’ ACTIVAR
- â¬œ Secret scanning push protection â†’ ACTIVAR
